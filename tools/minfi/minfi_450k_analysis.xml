<tool id="minfi_450k_analysis" name="Infinium HumanMethylation450 BeadChip" version="2.1.0">
    <description>Determines differentially methylated regions and positions from idat files</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements">
  <requirement type="package" version="0.6.0">bioconductor-illuminahumanmethylation450kanno.ilmn12.hg19</requirement>
    </expand>
    <command detect_errors="exit_code"><![CDATA[
      #for $counter, $input in enumerate($files_red):
        #set $redname = str( getattr( $input, 'element_identifier', 'sample' ) ).replace( "/", '-' ).replace( "\t", "-" )
        ln -s $input ./${redname} &&
      #end for
      #for $counter, $input in enumerate($files_grn):
        #set $grnname = str( getattr( $input, 'element_identifier', 'sample' ) ).replace( "/", '-' ).replace( "\t", "-" )
        ln -s $input ./${grnname} &&
      #end for
      Rscript '$minfi_450k_analysis_script'
      ]]></command>
      <configfiles>
      <configfile name="minfi_450k_analysis_script"><![CDATA[
        require("minfi", quietly = TRUE)
	require("IlluminaHumanMethylation450kanno.ilmn12.hg19", quietly = TRUE)
        options(warn = -1)

	RGSet <- read.metharray(list.files(pattern="_Red.idat")) #load .IDAT files
	
	MSet <- preprocessRaw(RGSet) #create objects contains CpGs signals
	
        qc <- getQC(MSet)
        write.table(qc, '$qctab') #optional - provides a simple quality control matrix and plot
        png('$qcpng')
        plotQC(qc)
        dev.off()
         
	RSet <- ratioConvert(MSet, what = "both", keepCN = TRUE) #store Beta values and/or M values
        GRSet <- mapToGenome(RSet)

	if ('$optpp' == "na" ) {
	GRSet <- mapToGenome(RSet) #mapping Ilumina methylation array data to the genome
	} else if ('$optpp' == "ppfun"  ) {
	GRSet <- preprocessFunnorm(RGSet) #optional - implements the functional normalization algorithm
	} else  if ('$optpp' == "ppq" ) {
	GRSet <- preprocessQuantile(RGSet, fixOutliers = TRUE,
        removeBadSamples = TRUE, badSampleCutoff = 10.5,
        quantileNormalize = TRUE, stratified = TRUE,
        mergeManifest = FALSE, sex = NULL) #optional - implements stratified quantile normalization preprocessing
	}  else if ('$optpp' == "ppsnp" ) {
	snps <- getSnpInfo(GRSet) #optional - retrieve the chromosome and the position of each SNP
	write.table(snps, '$table')
	GRSet <- dropLociWithSnps(GRSet, snps=c("SBE","CpG"), maf=0) #optional - drop the probes that contain either a SNP at the CpG interrogation or at the single nucleotide extensions
        } 

	###dmr###
	pheno <- read.table('$phenotype_table',skip = 1) 
	group <- pheno\$V2
        pair <- factor(pheno\$V3)
        design.matrix <- model.matrix(~ group + pair)
        maxGap <- as.numeric('$maxgap_size')
          if(is.null(GRSet\$cluster)){
          cluster = NULL
          maxGap = maxGap
          } else {
          cluster = GRSet\$cluster
          maxGap = NULL
          }
        cutoff <- as.numeric('$cutoff_size')
        B <- as.numeric('$number_of_resamples')
        nullMethod <- '$null_method'
	coef <- 2

	dmrs <- bumphunter(GRSet,
        design = design.matrix,
        cluster = cluster,
        maxGap = maxGap,
        cutoff = cutoff,
        nullMethod = nullMethod,
        B = B) #find differentially methylated regions

	dmrGR <- dmrs\$table[,c("chr","start","end")]

        write.table(dmrGR, file="Differentially_Methylated_Regions.bed", quote=F, sep="\t", row.names=F, col.names=F)


	###dmp###

	genomeranges <- as.data.frame(ranges(GRSet))

        beta <- getBeta(GRSet)

        type <- '$phenotype'

        qCutoff <- as.numeric('$q_cutoff')

        shrinkVar <- '$variance_shrinkage'

        tab <- read.table('$ucsc_genome')

        tab <- tab[,-(11:14),drop=FALSE]

        tab <- tab[,c(1,4,5,10)]

        colnames(tab) <- c('chr','start','end','names')

        dmp <- dmpFinder(beta, pheno[,"V2"], type = type, qCutoff = qCutoff, shrinkVar = shrinkVar)

        dmp[,"names"] <- rownames(dmp)

        data <- merge(dmp, tab, by="names",sort = TRUE)

        col_order <- c("chr","start","end","names","intercept", "pval", "qval", "f")
        data <- data[, col_order]
	
	write.table(data, file="Differentially_Methylated_Regions.bed", quote=F, sep="\t", row.names=F, col.names=F)

       
        ]]> </configfile>
        </configfiles>
	<inputs>		
	<param type="data" name="files_red" multiple="true" format="idat" label="Red .IDAT files"/>
        <param type="data" name="files_grn" multiple="true" format="idat" label="Green .IDAT files" />
        <param name="optpp" type="select" label="Optional) Preprocessing Method" help="Mapping Ilumina methylation array data to the genome with or without additional preprocess.">
            <option value="na">No Selection (use default)</option>
	    <option value="ppfun">Preprocess Funnorm</option>
	    <option value="ppq">Preprocess Quantile</option>
            <option value="ppsnp">Remove SNPs</option>
        </param> 
        <param type="data" name="phenotype_table" format="tabular" label="Phenotype Table"
            help="Phenotype Table must include the following information: sampleID, phenotype and paird or unpaired samples column"/>
        <param name="maxgap_size" type="integer" value="250" label="maxGap Size"
            help="If cluster is not provided this maximum location gap will be used to define cluster"/>
        <param name="cutoff_size" type="float" value="0.1" label="Cutoff Size"
            help="A numeric value. Values of the estimate of the genomic profile above the cutoff or below the negative of the cutoff will be used as candidate regions. It is possible to give two separate values (upper and lower bounds). If one value is given, the lower bound is minus the value."/> 
        <param name="number_of_resamples" type="integer" value="0" label="Number of Resamples"
            help="An integer denoting the number of resamples to use when computing null distributions. This defaults to 0. If permutations is supplied that defines the number of permutations/bootstraps and B is ignored."/>
        <param name="null_method" type="select" label="null Method" help="Method used to generate null candidate region.">
            <option value="permutation" selected="True">permutation</option>
	    <option value="bootstrap">bootstrap</option>
	   </param>
	   <param name="phenotype" type="select" label="Phenotype Type">
            <option value="categorical">categorical</option>
	    <option value="continuous">continuous</option>
	</param>
        <param name="q_cutoff" type="float" value="1" label="qCutoff Size" help="DMPs with an FDR q-value greater than this will not be returned."/>
        <param name="variance_shrinkage" type="boolean" truevalue="TRUE" falsevalue="FALSE" label="Variance Shrinkage" help="Enable variance shrinkage is recommended when sample sizes are small"/>
        <param type="data" name="ucsc_genome" format="gtf" label="Genome Table" help="UCSC genome data Methyl450"/>
         </inputs>
	     <outputs>
             <data name="qctab" format="txt" label="Quality Control Report"/>
	     <data name="qcpng" format="png" label="Quality Control Plot"/>
	     <data name="table" format="txt" label="SNPInfo Table"/>
	     <data name="dmr" format="tabular" label="Differentially Methylated Regions"/>   
	     <data name="dmp" format="tabular" label="Differentially Methylated Positions"/>
               </outputs>
             <tests>
         <test>
            <param name="files_red" value="GSM1588707_8795207119_R06C02_Red.idat,GSM1588706_8795207135_R02C02_Red.idat,GSM1588705_8795207119_R05C02_Red.idat,GSM1588704_8795207135_R01C02_Red.idat" ftype="idat"/>
            <param name="files_grn" value="GSM1588707_8795207119_R06C02_Grn.idat,GSM1588706_8795207135_R02C02_Grn.idat,GSM1588705_8795207119_R05C02_Grn.idat,GSM1588704_8795207135_R01C02_Grn.idat" ftype="idat"/>
	    <param name="phenotype_table" value="phenotypeTable.txt"/>
	    <param name="optpp" value="ppsnp"/>
            <param name="maxgap_size" value="250"/>
            <param name="cutoff_size" value="0.1"/>
            <param name="number_of_resamples" value="0"/>
	    <param name="null_method" value="permutation"/>
	    <param name="phenotype" value="categorical"/>
            <param name="q_cutoff" value="1"/>
            <param name="variance_shrinkage" value="FALSE"/>
            <param name="ucsc_genome" value="ucsc.gtf"/>
	    <output name="qctab" file="Quality_Control_Report.txt"/>
	    <output name="qcpng" file="Quality_Control_Plot.png" compare="sim_size"/>
	    <output name="table" file="SNPInfo_Table.txt"/>
	    <output name="dmr" file="Differentially_Methylated_Regions.tabular"/>
	    <output name="dmp" file="Differentially_Methylated_Positions.tabular"/>
        </test>
    </tests>
    <help><![CDATA[
The tool loads the binary 450K array “IDAT” raw files generated by the Illumina Scanner. In addition to the methylated and an unmethylated intensity values for each 450,000 CpG positions, IDAT file contains some extra info such as control probes.

]]></help>
    <citations>
        <citation type="doi">10.18129/B9.bioc.illuminaio</citation>
</citations>
</tool>
