<tool id="minfi_450k_analysis" name="450k Methylation Array Analysis" version="2.1.0">
    <description>450k Methylation Array Analysis</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements">
  <requirement type="package" version="0.6.0">bioconductor-illuminahumanmethylation450kanno.ilmn12.hg19</requirement>
    </expand>
    <command detect_errors="exit_code"><![CDATA[
      #for $counter, $input in enumerate($files_red):
        #set $redname = str( getattr( $input, 'element_identifier', 'sample' ) ).replace( "/", '-' ).replace( "\t", "-" )
        ln -s $input ./${redname} &&
      #end for
      #for $counter, $input in enumerate($files_grn):
        #set $grnname = str( getattr( $input, 'element_identifier', 'sample' ) ).replace( "/", '-' ).replace( "\t", "-" )
        ln -s $input ./${grnname} &&
      #end for
      Rscript '$minfi_450k_analysis_script'
      ]]></command>
      <configfiles>
      <configfile name="minfi_450k_analysis_script"><![CDATA[
        require("minfi", quietly = TRUE)
	require("IlluminaHumanMethylation450kanno.ilmn12.hg19", quietly = TRUE)

	RGSet <- read.metharray(list.files(pattern="_Red.idat")) #load .IDAT files
	
	MSet <- preprocessRaw(RGSet) #create objects contains CpGs signals
	
	qc <- getQC(MSet)
	write.table(qc, '$qctab') #optional - provides a simple quality control matrix and plot
	png('$qcpng')
	plotQC(qc)
	dev.off()

	RSet <- ratioConvert(MSet, what = "both", keepCN = TRUE) #store Beta values and/or M values
        
	GRSet <- mapToGenome(RSet) #mapping Ilumina methylation array data to the genome

	GRSet <- preprocessFunnorm(RGSet) #optional - implements the functional normalization algorithm<
	GRSet <- preprocessQuantile(RGSet, fixOutliers = TRUE,
  removeBadSamples = TRUE, badSampleCutoff = 10.5,
  quantileNormalize = TRUE, stratified = TRUE,
  mergeManifest = FALSE, sex = NULL) #optional - implements stratified quantile normalization preprocessing
      
        snps <- getSnpInfo(GRSet) #optional - retrieve the chromosome and the position of each SNP
	write.table(snps, '$table')

	GRSet <- dropLociWithSnps(GRSet, snps=c("SBE","CpG"), maf=0) #optional - drop the probes that contain either a SNP at the CpG interrogation or at the single nucleotide extensions
        ]]> </configfile>
        </configfiles>
        <inputs>
        <param type="data" name="files_red" multiple="true" format="idat" label="Red .IDAT files"/>
          <param type="data" name="files_grn" multiple="true" format="idat" label="Green .IDAT files" />
            </inputs>
	    <outputs>
            <data name="qctab" format="txt" label="Quality Control Report"/>
	    <data name="qcpng" format="png" label="Quality Control Plot"/>
	    <data name="table" format="txt" label="SNPInfo Table"/>
            
              </outputs>
             <tests>
        <test>
            <param name="files_red" value="GSM1588707_8795207119_R06C02_Red.idat,GSM1588706_8795207135_R02C02_Red.idat,GSM1588705_8795207119_R05C02_Red.idat,GSM1588704_8795207135_R01C02_Red.idat" ftype="idat"/>
            <param name="files_grn" value="GSM1588707_8795207119_R06C02_Grn.idat,GSM1588706_8795207135_R02C02_Grn.idat,GSM1588705_8795207119_R05C02_Grn.idat,GSM1588704_8795207135_R01C02_Grn.idat" ftype="idat"/>
            <output name="qctab" file="Quality_Control_Report.txt"/>
	    <output name="qcpng" file="Quality_Control_Plot.png" compare="sim_size"/>
	    <output name="table" file="SNPInfo_Table.txt"/>
        </test>
    </tests>
    <help><![CDATA[
The tool loads the binary 450K array “IDAT” raw files generated by the Illumina Scanner. In addition to the methylated and an unmethylated intensity values for each 450,000 CpG positions, IDAT file contains some extra info such as control probes.

]]></help>
    <citations>
        <citation type="doi">10.18129/B9.bioc.illuminaio</citation>
</citations>
</tool>
