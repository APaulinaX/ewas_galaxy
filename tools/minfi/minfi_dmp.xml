<tool id="minfi_dmp" name="Minfi DMP" version="@MINFI_VERSION@">
    <description>to find differentially methylated positions</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript '$minfi_dmp_script'
    ]]></command>
    <configfiles>
        <configfile name="minfi_dmp_script"><![CDATA[
require("minfi", quietly = TRUE)

set <- get(load('$grset'))

genomeranges <- as.data.frame(ranges(set))

beta <- getBeta(set)

pheno <- read.table('$phenotype_table',skip=1)

type <- '$phenotype'

qCutoff <- as.numeric('$q_cutoff')

shrinkVar <- '$variance_shrinkage'

tab <- read.table('$ucsc_genome')

tab <- tab[,-(11:14),drop=FALSE] 

tab <- tab[,c(1,4,5,10)]

colnames(tab) <- c('chr','start','end','names')

dmp <- dmpFinder(beta, pheno[,"V2"], type = type, qCutoff = qCutoff, shrinkVar = shrinkVar)

dmp[,"names"] <- rownames(dmp)

data <- merge(dmp, tab, by="names",sort = TRUE)

data <- data[,c(6,7,8,1,4,5)]  

write.table(data, file= '$dmp', quote = FALSE,col.names = TRUE, row.names = FALSE, sep = "\t")
]]>
        </configfile>
    </configfiles> 
    <inputs>
        <param type="data" name="grset" format="rdata" label="Data Mapped To The Genome" help="MethylSet, RatioSet or GenomicRatioSet" />
        <param type="data" name="phenotype_table" format="tabular" label="Phenotype Table"/>
        <param name="phenotype" type="select" label="Phenotype Type">
            <option value="categorical">categorical</option>
            <option value="continuous">continuous</option>
        </param> 
        <param name="q_cutoff" type="float" value="1" label="qCutoff Size" help="DMPs with an FDR q-value greater than this will not be returned."/>
        <param name="variance_shrinkage" type="boolean" truevalue="TRUE" falsevalue="FALSE" label="Variance Shrinkage"
            help="Enable variance shrinkage is recommended when sample sizes are small"/>
        <param type="data" name="ucsc_genome" format="gtf" label="Genome Table" help="UCSC genome data Methyl450"/>
    </inputs>
    <outputs>
       <data name="dmp" format="interval" label="Differentially Methylated Positions"/>
    </outputs>
    <tests>
        <test>
            <param name="grset" value="GRSet_without_SNPs.rdata"/>
            <param name="phenotype_table" value="phenotypeTable.txt"/>
            <param name="phenotype" value="categorical"/>
            <param name="q_cutoff" value="1"/>
            <param name="variance_shrinkage" value="FALSE"/>
            <param name="ucsc_genome" value="ucsc.gtf"/>
            <output name="dmp" file="Differentially_Methylated_Positions.interval"/>
        </test>
    </tests>
    <help><![CDATA[

**What it does**

Minfi DMP retrieves differentially methylated positions (DMPs) with respect to a phenotype covariate. 
The phenotype variable might be categorical (e.g. cancer vs. normal) or continuous (e.g. blood pressure). 

**Input information**

Input data is GenomicRatioSet, Phenotype Table with coresponding Genome Table

GenomicRatioSet class is an R object (i.e. generated by Minfi Map to Genome Tool) holding preprocessed data for Illumina methylation microarrays, mapped to a genomic location.
It should contain 450k arrays files for each sample listed in Phenotype Table: sample accession (ID) and phenotype paired e.g. 
============ ============ ============
  Accession	 Sensitivity   Treatment
------------ ------------ ------------ 
GSM1588704	 sensitive	   MAPKi
GSM1588705	 sensitive	   MAPKi
GSM1588706	 resistant	   BRAFi
GSM1588707	 resistant	   BRAFi
============ ============ ============

UCSC genome data HAIB Methyl450 could be obtained using UCSC Main table browser tool with following settings:

"clade": Mammal
"genome": Human
"assembly": Feb. 2009 (GRCh37/hg19)
"group": Regulation
"track": HAIB Methyl450
"table": GM12878 (wgEncodeHaibMethyl450Gm12878SitesRep1)
"region": genome
"output format": GTF - gene transfer (limited)
"Send output to": Galaxy (only)


**Output information**

The output is an interval file with the following columns:
============ ============ ============ ============ ======================== ========================
  chr	       start       end          names	      pval	                   qval
------------ ------------ ------------ ------------ ------------------------  ------------------------  
chr16	     53468112	  53468112	   cg00000029	0.273485175006601	      0.239609190206712
chr3	     37459206	  37459206	   cg00000108	0.623243998636913	      0.39258989981719
chr3	     171916037	  171916037	   cg00000109	0.232539543925332	      0.216244969633372
chr1	     91194675	  91194675	   cg00000165	0.248020671814953	      0.225232373436069
chr8	     42263295	  42263295	   cg00000236	0.230215862279736	      0.214851543324713
============ ============ ============ ============ ======================== ========================

 ]]></help>
    <expand macro="citations" />
</tool>
